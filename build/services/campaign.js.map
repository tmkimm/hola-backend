{"version":3,"file":"campaign.js","sourceRoot":"/","sources":["services/campaign.ts"],"names":[],"mappings":"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","sourcesContent":["import { Types } from 'mongoose';\nimport CustomError from '../CustomError';\nimport { IAdvertisementModel } from '../models/Advertisement';\nimport { ICampaignDocument, ICampaignModel } from '../models/Campaign';\nimport { IAdvertisementLogModel } from '../models/AdvertisementLog';\n\nexport class CampaignService {\n  constructor(\n    protected campaignModel: ICampaignModel,\n    protected advertisementModel: IAdvertisementModel,\n    protected advertisementLogModel: IAdvertisementLogModel\n  ) {}\n\n  // 캠페인 리스트 조회\n  async findCampaignList(page: string | null) {\n    let result: ICampaignDocument[] = await this.campaignModel.findCampaignListInPagination(page);\n    return result;\n  }\n\n  // 캠페인 상세 조회\n  async findCampaign(campaignId: Types.ObjectId) {\n    const campaign = await this.campaignModel.findCampaign(campaignId);\n    if (!campaign) throw new CustomError('NotFoundError', 404, 'Campaign not found');\n    return campaign;\n  }\n\n  // 캠페인 등록\n  async createCampaign(campaign: ICampaignDocument) {\n    const campaignRecord = await this.campaignModel.create(campaign);\n    return campaignRecord;\n  }\n\n  // 캠페인 수정\n  async modifyCampaign(id: Types.ObjectId, campaign: ICampaignDocument) {\n    const campaignRecord = await this.campaignModel.modifyCampaign(id, campaign);\n    return campaignRecord;\n  }\n\n  // 캠페인 삭제\n  async deleteCampaign(id: Types.ObjectId) {\n    await this.campaignModel.deleteCampaign(id);\n  }\n\n  // 캠페인의 광고 리스트 조회\n  async findAdvertisementInCampaign(campaignId: Types.ObjectId) {\n    return await this.advertisementModel.findAdvertisementInCampaign(campaignId);\n  }\n\n  // 광고 결과 집계\n  async findCampaignResult(campaignId: Types.ObjectId) {\n    const campaign = await this.findCampaign(campaignId);\n    const adList = await this.advertisementModel.findAdvertisementInCampaign(campaignId);\n    const adIdList = adList.map((ad: any) => {\n      return Types.ObjectId(ad._id);\n    });\n    // 로그 집계\n    const aggregate = await this.advertisementLogModel.findADResult(adIdList);\n    const logAggregate = aggregate.map((ad: any) => {\n      return {\n        _id: ad._id.advertisementId,\n        logType: ad._id.logType,\n        count: ad.count,\n        advertisementType: ad.advertisements.advertisementType,\n      };\n    });\n    // 광고 성과 형식으로 그룹핑\n    let result: any = [];\n    logAggregate.forEach((element: any) => {\n      let index = result.findIndex((v: any) => (v.advertisementType === element.advertisementType ? true : false));\n      if (index === -1) {\n        result.push({\n          advertisementType: element.advertisementType,\n          advertisementId: element._id,\n          [element.logType]: element.count,\n        });\n      } else {\n        result[index] = {\n          ...result[index],\n          [element.logType]: element.count,\n        };\n      }\n    });\n\n    // 전환비용, 클릭률 세팅\n    result = result.map((v: any) => {\n      if (!v.reach || !v.impression) return v;\n      const reachRate = ((v.reach / v.impression) * 100).toFixed(2) + '%';\n      const reachPrice = (campaign.conversionCost * v.reach).toFixed(0);\n      return {\n        ...v,\n        reachRate,\n        reachPrice,\n      };\n    });\n    return result;\n  }\n}\n"]}