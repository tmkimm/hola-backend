{"version":3,"file":"post.js","sourceRoot":"/","sources":["services/post.ts"],"names":[],"mappings":"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","sourcesContent":["import sanitizeHtml from 'sanitize-html';\r\nimport { Types } from 'mongoose';\r\nimport { IPost, IPostModel, IPostDocument } from '../models/Post';\r\nimport { INotificationModel } from '../models/Notification';\r\nimport { PostFilterLog } from '../models/PostFilterLog';\r\nimport { ReadPosts } from '../models/ReadPosts';\r\nimport { LikePosts } from '../models/LikePosts';\r\n\r\nimport { IUserModel } from '../models/User';\r\nimport CustomError from '../CustomError';\r\n\r\nexport class PostService {\r\n  constructor(\r\n    protected postModel: IPostModel,\r\n    protected userModel: IUserModel,\r\n    protected notificationModel: INotificationModel,\r\n  ) {}\r\n\r\n  // 리팩토링필요\r\n  // 메인 화면에서 글 리스트를 조회한다.\r\n  async findPost(\r\n    offset: number | null,\r\n    limit: number | null,\r\n    sort: string | null,\r\n    language: string | null,\r\n    period: number | null,\r\n    isClosed: string | null,\r\n    type: string | null,\r\n    position: string | null,\r\n    search: string | null,\r\n  ) {\r\n    const posts = await this.postModel.findPost(\r\n      offset,\r\n      limit,\r\n      sort,\r\n      language,\r\n      period,\r\n      isClosed,\r\n      type,\r\n      position,\r\n      search,\r\n    );\r\n    // 언어 필터링 로그 생성\r\n    if (language) {\r\n      await PostFilterLog.create({\r\n        viewDate: new Date(),\r\n        language: language.split(','),\r\n      });\r\n    }\r\n    return posts;\r\n  }\r\n\r\n  // 메인 화면에서 글 리스트를 조회한다.\r\n  async findPostPagination(\r\n    page: string | null,\r\n    previousPage: string | null,\r\n    lastId: Types.ObjectId | string,\r\n    sort: string | null,\r\n    language: string | null,\r\n    period: number | null,\r\n    isClosed: string | null,\r\n    type: string | null,\r\n    position: string | null,\r\n    search: string | null,\r\n    userId: string | null,\r\n  ) {\r\n    let result: any = await this.postModel.findPostPagination(\r\n      page,\r\n      previousPage,\r\n      lastId,\r\n      sort,\r\n      language,\r\n      period,\r\n      isClosed,\r\n      type,\r\n      position,\r\n      search,\r\n    );\r\n    // 관심 등록 여부 추가\r\n    if (userId) {\r\n      const { posts } = result;\r\n      const addIsLike = posts.map((post: any) => {\r\n\r\n        let isLiked = false;\r\n        if(post.likes && post.likes.length > 0) {\r\n          for(const likeUserId of post.likes) {\r\n            if(likeUserId.toString() == userId) {\r\n              isLiked = true;\r\n              break;\r\n            }\r\n          }\r\n        }\r\n\r\n        post.isLiked = isLiked;\r\n        return post;\r\n      });\r\n      result.posts = addIsLike;\r\n    }\r\n\r\n    // 언어 필터링 로그 생성\r\n    if (language) {\r\n      await PostFilterLog.create({\r\n        viewDate: new Date(),\r\n        language: language.split(','),\r\n      });\r\n    }\r\n    return result;\r\n  }\r\n\r\n  // Pagination을 위해 마지막 페이지를 구한다.\r\n  async findLastPage(\r\n    language: string | null,\r\n    period: number | null,\r\n    isClosed: string | null,\r\n    type: string | null,\r\n    position: string | null,\r\n    search: string | null,\r\n  ) {\r\n    const itemsPerPage = 4 * 6; // 한 페이지에 표현할 수\r\n    const totalCount = await this.postModel.countPost(language, period, isClosed, type, position, search);\r\n    const lastPage = Math.ceil(totalCount / itemsPerPage);\r\n    return lastPage;\r\n  }\r\n\r\n  // 인기글 조회\r\n  async findPopularPosts(postId: Types.ObjectId, userId: Types.ObjectId) {\r\n    const posts = await this.postModel.findPopularPosts(postId, userId);\r\n    return posts;\r\n  }\r\n\r\n  // 메인 화면에서 글를 추천한다.(현재 미사용, 제거예정)\r\n  async recommendToUserFromMain(userId: Types.ObjectId) {\r\n    let sort;\r\n    let likeLanguages = null;\r\n    const limit = 20;\r\n    if (userId) {\r\n      const user = await this.userModel.findById(userId);\r\n      if (user !== null && user.likeLanguages) likeLanguages = user.likeLanguages;\r\n      sort = 'views';\r\n    } else {\r\n      sort = 'totalLikes';\r\n    }\r\n\r\n    const posts = await this.postModel.findPostRecommend('-views', likeLanguages, null, null, limit);\r\n    return posts;\r\n  }\r\n\r\n  // 글에서 글를 추천한다.\r\n  async recommendToUserFromPost(postId: Types.ObjectId, userId: Types.ObjectId) {\r\n    const sort = '-views';\r\n    let language = null;\r\n    const limit = 10;\r\n    if (postId) {\r\n      const post = await this.postModel.findById(postId);\r\n      if (post === null) throw new CustomError('JsonWebTokenError', 404, 'Post not found');\r\n\r\n      language = post.language;\r\n    }\r\n\r\n    const posts = await this.postModel.findPostRecommend(sort, language, postId, userId, limit);\r\n    return posts;\r\n  }\r\n\r\n  // 조회수 증가\r\n  async increaseView(postId: Types.ObjectId, userId: Types.ObjectId, readList: string) {\r\n    let isAlreadyRead = true;\r\n    let updateReadList = readList;\r\n    // 조회수 중복 증가 방지\r\n    if (readList === undefined || (typeof readList === 'string' && readList.indexOf(postId.toString()) === -1)) {\r\n      if (userId)\r\n        await Promise.all([\r\n          await ReadPosts.create({\r\n            userId,\r\n            postId,\r\n          }),\r\n          this.postModel.increaseView(postId),\r\n        ]);\r\n      else await this.postModel.increaseView(postId); // 조회수 증가\r\n\r\n      if (readList === undefined) updateReadList = `${postId}`;\r\n      else updateReadList = `${readList}|${postId}`;\r\n      isAlreadyRead = false;\r\n    }\r\n    return { updateReadList, isAlreadyRead };\r\n  }\r\n\r\n  // 상세 글 정보를 조회한다.\r\n  // 로그인된 사용자일 경우 읽은 목록을 추가한다.\r\n  async findPostDetail(postId: Types.ObjectId) {\r\n    const posts = await this.postModel.findById(postId).populate('author', 'nickName image');\r\n    if (!posts) throw new CustomError('NotFoundError', 404, 'Post not found');\r\n    return posts;\r\n  }\r\n\r\n  // 사용자의 관심 등록 여부를 조회한다.\r\n  async findUserLiked(postId: Types.ObjectId, userId: Types.ObjectId) {\r\n    if (userId && postId) {\r\n      const posts = await this.postModel.find({ _id: postId, likes: userId });\r\n      const isLiked = posts.length > 0;\r\n      return isLiked;\r\n    }\r\n    return false;\r\n  }\r\n\r\n  // 글의 관심 등록한 사용자 리스트를 조회한다.\r\n  async findLikeUsers(postId: Types.ObjectId) {\r\n    const likeUsers = await this.postModel.findById(postId).select('likes');\r\n    if (!likeUsers) return [];\r\n    return likeUsers.likes;\r\n  }\r\n\r\n  // 신규 글를 등록한다.\r\n  async registerPost(userID: Types.ObjectId, post: IPostDocument) {\r\n    post.author = userID;\r\n    if (post.content) {\r\n      const cleanHTML = sanitizeHtml(post.content, {\r\n        allowedTags: sanitizeHtml.defaults.allowedTags.concat(['img']),\r\n      });\r\n      post.content = cleanHTML;\r\n    }\r\n    const postRecord = await this.postModel.create(post);\r\n    return postRecord;\r\n  }\r\n\r\n  // 글 정보를 수정한다.\r\n  async modifyPost(id: Types.ObjectId, tokenUserId: Types.ObjectId, tokenType: string, post: IPost) {\r\n    await this.postModel.checkPostAuthorization(id, tokenUserId, tokenType); // 접근 권한 체크\r\n    if (post.content) {\r\n      const cleanHTML = sanitizeHtml(post.content, {\r\n        allowedTags: sanitizeHtml.defaults.allowedTags.concat(['img']),\r\n      });\r\n      post.content = cleanHTML;\r\n    }\r\n    const postRecord = await this.postModel.modifyPost(id, post);\r\n    return postRecord;\r\n  }\r\n\r\n  // 글를 삭제한다.\r\n  async deletePost(id: Types.ObjectId, tokenUserId: Types.ObjectId, tokenType: string) {\r\n    await this.postModel.checkPostAuthorization(id, tokenUserId, tokenType); // 접근 권한 체크\r\n    await this.postModel.deletePost(id);\r\n    await this.notificationModel.deleteNotificationByPost(id); // 글 삭제 시 관련 알림 제거\r\n  }\r\n\r\n  // 관심 등록 추가\r\n  async addLike(postId: Types.ObjectId, userId: Types.ObjectId) {\r\n    const { post, isLikeExist } = await this.postModel.addLike(postId, userId);\r\n    if (!isLikeExist) {\r\n      await LikePosts.add(postId, userId);\r\n      // await this.notificationModel.registerNotification(postId, post.author, userId, 'like');   // 알림 등록\r\n    }\r\n    return post;\r\n  }\r\n\r\n  // 관심 등록 취소(삭제)\r\n  async deleteLike(postId: Types.ObjectId, userId: Types.ObjectId) {\r\n    const { post, isLikeExist } = await this.postModel.deleteLike(postId, userId);\r\n    if (isLikeExist) {\r\n      await LikePosts.delete(postId, userId);\r\n      // await this.notificationModel.deleteNotification(postId, post.author, userId, 'like');   // 알림 삭제\r\n    }\r\n    return post;\r\n  }\r\n\r\n  // 자동 마감\r\n  async autoClosing() {\r\n    await this.postModel.autoClosing();\r\n  }\r\n}\r\n"]}