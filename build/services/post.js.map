{"version":3,"file":"post.js","sourceRoot":"/","sources":["services/post.ts"],"names":[],"mappings":"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","sourcesContent":["import sanitizeHtml from 'sanitize-html';\nimport { Types } from 'mongoose';\nimport { IPost, IPostModel, IPostDocument } from '../models/Post';\nimport { INotificationModel } from '../models/Notification';\nimport { IUserModel } from '../models/User';\nimport CustomError from '../CustomError';\n\nexport class PostService {\n  constructor(\n    protected postModel: IPostModel,\n    protected userModel: IUserModel,\n    protected notificationModel: INotificationModel,\n  ) {}\n\n  // 리팩토링필요\n  // 메인 화면에서 글 리스트를 조회한다.\n  async findPost(\n    offset: number | null,\n    limit: number | null,\n    sort: string | null,\n    language: string | null,\n    period: number | null,\n    isClosed: string | null,\n    type: string | null,\n  ) {\n    const posts = await this.postModel.findPost(offset, limit, sort, language, period, isClosed, type);\n\n    const sortPosts = this.sortLanguageByQueryParam(posts, language);\n    return sortPosts;\n  }\n\n  // 선택한 언어가 리스트의 앞에 오도록 정렬\n  async sortLanguageByQueryParam(posts: IPostDocument[], language: string | null) {\n    if (typeof language !== 'string') return posts;\n\n    const paramLanguage = language.split(',');\n    for (let i = 0; i < posts.length; i += 1) {\n      posts[i].language.sort(function (a, b) {\n        if (paramLanguage.indexOf(b) !== -1) return 1;\n        return -1;\n      });\n    }\n    return posts;\n  }\n\n  // 메인 화면에서 글를 추천한다.\n  // 4건 이하일 경우 무조건 다시 조회가 아니라, 해당 되는 건은 포함하고 나머지 건만 조회해야한다.\n  async recommendToUserFromMain(userId: Types.ObjectId) {\n    let sort;\n    let likeLanguages = null;\n    const limit = 20;\n    if (userId) {\n      const user = await this.userModel.findById(userId);\n      if (user !== null && user.likeLanguages) likeLanguages = user.likeLanguages;\n      sort = 'views';\n    } else {\n      sort = 'totalLikes';\n    }\n\n    const posts = await this.postModel.findPostRecommend('-views', likeLanguages, null, null, limit);\n    return posts;\n  }\n\n  // 글에서 글를 추천한다.\n  // 4건 이하일 경우 무조건 다시 조회가 아니라, 해당 되는 건은 포함하고 나머지 건만 조회해야함\n  async recommendToUserFromPost(postId: Types.ObjectId, userId: Types.ObjectId) {\n    const sort = '-views';\n    let language = null;\n    const limit = 10;\n    if (postId) {\n      const post = await this.postModel.findById(postId);\n      if (post === null) throw new CustomError('JsonWebTokenError', 404, 'Post not found');\n\n      language = post.language;\n    }\n\n    const posts = await this.postModel.findPostRecommend(sort, language, postId, userId, limit);\n    return posts;\n  }\n\n  // 조회수 증가\n  async increaseView(postId: Types.ObjectId, userId: Types.ObjectId, readList: string) {\n    let isAlreadyRead = true;\n    let updateReadList = readList;\n\n    // 조회수 중복 증가 방지\n    if (readList === undefined || (typeof readList === 'string' && readList.indexOf(postId.toString()) === -1)) {\n      if (userId) await Promise.all([this.userModel.addReadList(postId, userId), this.postModel.increaseView(postId)]);\n      else await this.postModel.increaseView(postId); // 조회수 증가\n\n      if (readList === undefined) updateReadList = `${postId}`;\n      else updateReadList = `${readList}|${postId}`;\n      isAlreadyRead = false;\n    }\n    return { updateReadList, isAlreadyRead };\n  }\n\n  // 상세 글 정보를 조회한다.\n  // 로그인된 사용자일 경우 읽은 목록을 추가한다.\n  async findPostDetail(postId: Types.ObjectId) {\n    const posts = await this.postModel\n      .findById(postId)\n      .populate('author', 'nickName image')\n      .populate('comments.author', 'nickName image');\n    return posts;\n  }\n\n  // 사용자의 관심 등록 여부를 조회한다.\n  async findUserLiked(postId: Types.ObjectId, userId: Types.ObjectId) {\n    if (userId && postId) {\n      const posts = await this.postModel.find({ _id: postId, likes: userId });\n      const isLiked = posts.length > 0;\n      return isLiked;\n    }\n    return false;\n  }\n\n  // 글의 관심 등록한 사용자 리스트를 조회한다.\n  async findLikeUsers(postId: Types.ObjectId) {\n    const likeUsers = await this.postModel.findById(postId).select('likes');\n    if (!likeUsers) return [];\n    return likeUsers.likes;\n  }\n\n  // 신규 글를 등록한다.\n  async registerPost(userID: Types.ObjectId, post: IPostDocument) {\n    post.author = userID;\n    if (post.content) {\n      const cleanHTML = sanitizeHtml(post.content, {\n        allowedTags: sanitizeHtml.defaults.allowedTags.concat(['img']),\n      });\n      post.content = cleanHTML;\n    }\n    const postRecord = await this.postModel.create(post);\n    return postRecord;\n  }\n\n  // 글 정보를 수정한다.\n  async modifyPost(id: Types.ObjectId, tokenUserId: Types.ObjectId, post: IPost) {\n    await this.postModel.checkPostAuthorization(id, tokenUserId); // 접근 권한 체크\n    if (post.content) {\n      const cleanHTML = sanitizeHtml(post.content, {\n        allowedTags: sanitizeHtml.defaults.allowedTags.concat(['img']),\n      });\n      post.content = cleanHTML;\n    }\n    const postRecord = await this.postModel.modifyPost(id, post);\n    return postRecord;\n  }\n\n  // 글를 삭제한다.\n  async deletePost(id: Types.ObjectId, tokenUserId: Types.ObjectId) {\n    await this.postModel.checkPostAuthorization(id, tokenUserId); // 접근 권한 체크\n    await this.postModel.deletePost(id);\n    await this.notificationModel.deleteNotificationByPost(id); // 글 삭제 시 관련 알림 제거\n  }\n\n  // 관심 등록 추가\n  async addLike(postId: Types.ObjectId, userId: Types.ObjectId) {\n    const { post, isLikeExist } = await this.postModel.addLike(postId, userId);\n    if (!isLikeExist) {\n      await this.userModel.addLikePost(postId, userId);\n      // await this.notificationModel.registerNotification(postId, post.author, userId, 'like');   // 알림 등록\n    }\n    return post;\n  }\n\n  // 관심 등록 취소(삭제)\n  async deleteLike(postId: Types.ObjectId, userId: Types.ObjectId) {\n    const { post, isLikeExist } = await this.postModel.deleteLike(postId, userId);\n    if (isLikeExist) {\n      await this.userModel.deleteLikePost(postId, userId);\n      // await this.notificationModel.deleteNotification(postId, post.author, userId, 'like');   // 알림 삭제\n    }\n    return post;\n  }\n}\n"]}