{"version":3,"file":"Notification.js","sourceRoot":"/","sources":["models/Notification.ts"],"names":[],"mappings":"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","sourcesContent":["import { Model, Schema, model, Types } from 'mongoose';\r\n\r\ninterface INotification {\r\n  title: string;\r\n  content: string;\r\n  isRead: boolean;\r\n  targetUserId: Types.ObjectId;\r\n  generateUserId: Types.ObjectId;\r\n  generateObjectId: Types.ObjectId;\r\n  href: string;\r\n  readAt?: Date;\r\n  noticeType: string;\r\n}\r\n\r\nexport interface INotificationDocument extends INotification, Document {}\r\n\r\nexport interface INotificationModel extends Model<INotificationDocument> {\r\n  findNotifications: (targetUserId: Types.ObjectId) => Promise<INotificationDocument>;\r\n  findNotification: (_id: Types.ObjectId) => Promise<INotificationDocument>;\r\n  findUnReadCount: (targetUserId: Types.ObjectId) => Promise<number>;\r\n  registerNotification: (\r\n    postId: Types.ObjectId,\r\n    targetUserId: Types.ObjectId,\r\n    generateUserId: Types.ObjectId,\r\n    noticeType: string,\r\n    generateObjectId: Types.ObjectId,\r\n    nickName: string,\r\n  ) => Promise<void>;\r\n  deleteNotification: (generateObjectId: Types.ObjectId) => Promise<void>;\r\n  deleteNotificationByPost: (href: Types.ObjectId) => Promise<void>;\r\n  deleteNotificationByUser: (userId: Types.ObjectId) => Promise<void>;\r\n  readNotification: (_id: Types.ObjectId) => Promise<void>;\r\n  readAll: (targetUserId: Types.ObjectId) => Promise<void>;\r\n}\r\n\r\nconst notificationSchema = new Schema<INotification>(\r\n  {\r\n    title: { type: String, default: null }, // ÏïåÎ¶º ÌÉÄÏù¥ÌãÄ\r\n    content: { type: String, default: null }, // ÏïåÎ¶º ÎÇ¥Ïö©\r\n    isRead: { type: Boolean, default: false }, // ÏùΩÏùå Ïó¨Î∂Ä\r\n    targetUserId: { type: Types.ObjectId, ref: 'User' }, // ÏïåÎ¶º Î∞õÏùÑÏÇ¨Îûå id\r\n    generateUserId: { type: Types.ObjectId, ref: 'User' }, // ÏïåÎ¶º Î≥¥ÎÇ∏ÏÇ¨Îûå id\r\n    generateObjectId: { type: Types.ObjectId }, // ÏïåÎ¶º Î∞úÏÉùÌïú Í≥≥  Id(Í∏Ä, ÎåìÍ∏Ä Îì±)\r\n    href: { type: String, default: null }, // Ïù¥ÎèôÌï† ÎßÅÌÅ¨\r\n    readAt: Date, // ÏùΩÏùÄ ÏãúÍ∞Ñ\r\n    noticeType: String, // ÏïåÎ¶º Íµ¨Î∂Ñ(like, comment, reply, couphone, notice)\r\n  },\r\n  {\r\n    versionKey: false,\r\n    timestamps: true,\r\n    toObject: { virtuals: true },\r\n    toJSON: { virtuals: true },\r\n  },\r\n);\r\n\r\n// ÏïåÎ¶º Î¶¨Ïä§Ìä∏ Ï°∞Ìöå\r\nnotificationSchema.statics.findNotifications = async function (\r\n  targetUserId: Types.ObjectId,\r\n): Promise<INotificationDocument> {\r\n  // let limit = 5;\r\n  // const unReadCount = await this.countDocuments({ targetUserId, isRead: false });\r\n  // if (unReadCount >= 6) limit = unReadCount;\r\n\r\n  const result = await this.find({ targetUserId })\r\n    .populate('generateUserId', 'nickName')\r\n    // .populate({ path: 'postId', match: { isDeleted: false }, select: 'title' })\r\n    .sort('+isRead -createdAt')\r\n    .select(`title content isRead href generateUserId noticeType createdAt`)\r\n    // .limit(limit)\r\n    .lean();\r\n  return result;\r\n};\r\n\r\n// ÏïåÎ¶º ÏÉÅÏÑ∏ Ï°∞Ìöå\r\nnotificationSchema.statics.findNotification = async function (_id: Types.ObjectId): Promise<INotificationDocument> {\r\n  const result = await this.findOne({ _id })\r\n    .populate('generateUserId', 'nickName')\r\n    .select(`title content isRead href generateUserId noticeType createdAt`);\r\n\r\n  return result;\r\n};\r\n\r\n// ÏùΩÏßÄ ÏïäÏùÄ ÏïåÎ¶º Ïàò Ï°∞Ìöå\r\nnotificationSchema.statics.findUnReadCount = async function (targetUserId: Types.ObjectId): Promise<number> {\r\n  const unReadCount = await this.countDocuments({ targetUserId, isRead: false });\r\n  return unReadCount;\r\n};\r\n\r\n// Ïã†Í∑ú ÏïåÎ¶º Îì±Î°ù\r\nnotificationSchema.statics.registerNotification = async function (\r\n  postId: Types.ObjectId,\r\n  targetUserId: Types.ObjectId,\r\n  generateUserId: Types.ObjectId,\r\n  noticeType: string,\r\n  generateObjectId: Types.ObjectId,\r\n  nickName: string,\r\n): Promise<void> {\r\n  const isNoticeExist = await this.findOne({ href: postId.toString(), generateUserId });\r\n\r\n  let title: string;\r\n  // // ÏïåÎ¶º Íµ¨Î∂Ñ(like, comment, reply, couphone, notice)\r\n  if (!isNoticeExist && targetUserId !== generateUserId) {\r\n    switch (noticeType) {\r\n      case 'like':\r\n        title = `üëÄ ${nickName}ÎãòÏù¥ ÎÇ¥ Í∏ÄÏùÑ Î∂ÅÎßàÌÅ¨ÌñàÏñ¥Ïöî.`;\r\n        break;\r\n      case 'comment':\r\n        title = `üëÄ ${nickName}ÎãòÏù¥ ÎÇ¥ Í∏ÄÏóê ÎåìÍ∏ÄÏùÑ ÎÇ®Í≤ºÏñ¥Ïöî.`;\r\n        break;\r\n      case 'reply':\r\n        title = `üëÄ ${nickName}ÎãòÏù¥ ÎÇ¥ Í∏ÄÏóê ÎãµÍ∏ÄÏùÑ ÎÇ®Í≤ºÏñ¥Ïöî.`;\r\n        break;\r\n      default:\r\n        title = ``;\r\n        break;\r\n    }\r\n    await this.create({ targetUserId, generateUserId, href: postId, title, noticeType, generateObjectId });\r\n  }\r\n};\r\n\r\n// ÏïåÎ¶º ÏÇ≠Ï†ú\r\nnotificationSchema.statics.deleteNotification = async function (generateObjectId: Types.ObjectId): Promise<void> {\r\n  await this.deleteMany({ generateObjectId });\r\n};\r\n\r\n// Í∏Ä ÏÇ≠Ï†ú Ïãú Í¥ÄÎ†® ÏïåÎ¶º Ï†úÍ±∞\r\nnotificationSchema.statics.deleteNotificationByPost = async function (href: string): Promise<void> {\r\n  await this.deleteMany({ href });\r\n};\r\n\r\n// ÌöåÏõê ÌÉàÌá¥ Ïãú Í¥ÄÎ†® ÏïåÎ¶º Ï†úÍ±∞\r\nnotificationSchema.statics.deleteNotificationByUser = async function (userId: Types.ObjectId): Promise<void> {\r\n  await this.deleteMany({ $or: [{ targetUserId: userId }, { generateUserId: userId }] });\r\n};\r\n\r\n// updateReadAt, updateReadAtByPost Î∂ÑÎ¶¨ÌïòÍ∏∞\r\n\r\n// ÏïåÎ¶º ÏùΩÏùå Ï≤òÎ¶¨\r\nnotificationSchema.statics.readNotification = async function (_id: Types.ObjectId): Promise<void> {\r\n  await this.updateMany(\r\n    {\r\n      _id,\r\n      isRead: false,\r\n    },\r\n    {\r\n      readAt: new Date(),\r\n      isRead: true,\r\n    },\r\n  );\r\n};\r\n// ÏïåÎ¶º Ï†ÑÏ≤¥ ÏùΩÏùå Ï≤òÎ¶¨\r\nnotificationSchema.statics.readAll = async function (targetUserId: Types.ObjectId): Promise<void> {\r\n  await this.updateMany(\r\n    {\r\n      targetUserId,\r\n      isRead: false,\r\n    },\r\n    {\r\n      readAt: new Date(),\r\n      isRead: true,\r\n    },\r\n  );\r\n};\r\n\r\nconst Notification = model<INotificationDocument, INotificationModel>('Notification', notificationSchema);\r\n\r\nexport { Notification };\r\n"]}